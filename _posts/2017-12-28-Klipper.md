---
title: Klipper (3dprinter firmware)
published: true
tags: 3dprint firmware
excerpt_separator: ""
---
## Overview
[Fast 3D Printing with Raspberry Pi](https://hackaday.com/2017/12/26/fast-3d-printing-with-raspberry-pi-but-not-how-you-think/#more-285911)

[Klipper features](https://github.com/KevinOConnor/klipper/blob/master/docs/Features.md)

## Octoprint Installation

1. Install octoprint
2. Follow [instructions](https://github.com/KevinOConnor/klipper/blob/master/docs/Installation.md) 

- ssh to pi@octopi
- run commands
{% highlight bash %}
git clone https://github.com/KevinOConnor/klipper
./klipper/scripts/install-octopi.sh
{% endhighlight %}

The above will download Klipper, install some system dependencies, setup Klipper to run at system startup, and start the Klipper host software. It will require an internet connection and it may take a few minutes to complete.

## [Flashing firmware](https://github.com/KevinOConnor/klipper/blob/master/docs/Installation.md#building-and-flashing-the-micro-controller)
compile code 
{% highlight bash %}
cd ~/klipper/
make menuconfig
make
{% endhighlight %}

Finally, for common micro-controllers, the code can be flashed with:
Make sure octoprint is disconnected before.
{% highlight bash %}
sudo service klipper stop
make flash FLASH_DEVICE=/dev/ttyUSB0
sudo service klipper start
{% endhighlight %}

**Make sure to restart board afterward**: power off/on printer


## [Configure Octoprint to use Klipper](https://github.com/KevinOConnor/klipper/blob/master/docs/Installation.md#configuring-octoprint-to-use-klipper)

## [Configuring Klipper](https://github.com/KevinOConnor/klipper/blob/master/docs/Installation.md#configuring-klipper)

The Klipper configuration is stored in a text file on the Raspberry Pi. 

Starting from ramp config.
cp ~/klipper/config/generic-ramps.cfg ~/printer.cfg

The default Klipper startup script also places a log in /tmp/klippy.log which provides more detailed information.

{% highlight bash %}
tail -f /tmp/klippy.log
{% endhighlight %}

## Klipper plugin
There is a Klipper plugin that provide some ui in octoprint
and default config.

## [**Verify** config](https://github.com/KevinOConnor/klipper/blob/master/docs/Config_checks.md)

- enable display: choose entry
{% highlight ruby %}
# "RepRapDiscount 128x64 Full Graphic Smart Controller" type displays
{% endhighlight %}

- [Verify temperature](https://github.com/KevinOConnor/klipper/blob/master/docs/Config_checks.md#verify-temperature)

 temperature reading seems ok (room temperature)

 Verify that fan are on when temp is above than 50c

 Additional hotend temperature controlled Fans:

Add any number of aditional fans for cooling stepsticks or the coldend by adding

{% highlight ruby %}
[heater_fan example_fan]
pin: arX
heater: extruder
heater_temp: 50.0
fan_speed: 1
{% endhighlight %}

Sections to your config.cfg

Theyll switch on once your hotend is set to 50c and switch of once its cooled below 50c.

- [Verify M112](https://github.com/KevinOConnor/klipper/blob/master/docs/Config_checks.md#verify-m112)

 M112 => cause disconnect

- [Verify heaters](https://github.com/KevinOConnor/klipper/blob/master/docs/Config_checks.md#verify-heaters)

 extruder Temp control => heat / stabilized / off

- [Verify stepper motor enable pin](https://github.com/KevinOConnor/klipper/blob/master/docs/Config_checks.md#verify-stepper-motor-enable-pin)

 enable_pin ok, X/Y/Z free move

- [Verify endstops](https://github.com/KevinOConnor/klipper/blob/master/docs/Config_checks.md#verify-endstops)

Send: QUERY_ENDSTOPS (M119)
Recv: x:open y:TRIGGERED z:TRIGGERED

Discoeasy default build has [x- trigger on y axis](https://www.iot-experiments.com/dagoma-discoeasy200/)

As it is quite easy to rectify that => I have chanded it as shown here below.

**From now it is obligatory to remap or use alternative [marlin](https://github.com/IoT-Experiments/Marlin-DiscoEasy200)**

**After Remap**
![caption](https://www.iot-experiments.com/content/images/2018/01/IMG_20180114_103116.jpg)

 Check individual axis trigger (**M119**):
 - xAxis => ok (endstop_pin: ^ar3)
 - yAxis => ok (endstop_pin: ^ar15)
 - zAxis => ok (endstop_pin: ^!ar18)

- [Verify stepper motors](https://github.com/KevinOConnor/klipper/blob/master/docs/Config_checks.md#verify-stepper-motors)

Check individual axis stepper motor:
- STEPPER_BUZZ STEPPER=stepper_x => ok
- STEPPER_BUZZ STEPPER=stepper_y => ok
- STEPPER_BUZZ STEPPER=stepper_z => ok but **need to verify step_distance setting.**
- STEPPER_BUZZ STEPPER=extruder ( **with no filament**) => ok

- disable motors (**M84**)

- [Homing](https://github.com/KevinOConnor/klipper/issues/25) (**G28**) **mind the power switch** (also [\[discussion\]](https://github.com/KevinOConnor/klipper/issues/111))
  - G28 X0 => ok
  - G28 Y0 => ok
  - G28 Z0 => ok

  - G28 (full homing)
{% highlight ruby %}
[homing_override]
gcode:
 G28 Y0
 G28 X0
{% endhighlight %}

### Open Issue (dagome config)

- M112 - works, but hard to reconnect afterward
- cannot restart service from octoprint (need to issue sudo service klipper restart)
 by eg when ttyUSBx change
- fan control

- display click doesn't work (hardware issue)